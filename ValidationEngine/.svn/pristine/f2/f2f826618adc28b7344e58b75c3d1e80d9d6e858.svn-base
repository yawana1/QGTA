package main;

import java.net.URL;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;

import org.apache.log4j.Logger;
import org.apache.log4j.PropertyConfigurator;

import utils.ArgumentParser;
import validation.ValidationProcess;
import data.XML;
import data.xml.objects.App;

public class Main {
	private static Logger objLogger;
	private final static String APPLICATION_CONFIGURATION = "App.xml";
	private final static long START_TIME = System.currentTimeMillis();

	/**
	 * @param args
	 */
	public static void main(String[] args) {
		ArgumentParser objArgumentParser;
		String strApplicationConfigurationArgument;
		String strApplicationConfigurationFile;
		URL objURLApplicationConfigurationFile;
		String strPreviousReportsDirectoryArgument;
		Path objPreviousReportsDirectoryPath;
		String strSeasonNameArgument;
		String strSeasonName;		
		URL objURLLogFile;
		ValidationProcess objValidationProcess;
		long lngStartTime;
		
		try {
			objArgumentParser = new ArgumentParser(args);
			if (!(objArgumentParser.hasNext())) {
				System.out.println("Please enter the arguments in the command line. " + 
                                   "Example: -appConfig=App.xml -seasonName=12E (-previousReportDirectory=\reports)");
				objLogger.error("No argument(s) given in the command line");
				throw new RuntimeException("No argument(s) given in the command line");
			}
			
			///////////////////////////
			// The argument appConfig  
			///////////////////////////
			strApplicationConfigurationFile = null;
			strApplicationConfigurationArgument = objArgumentParser.getOption("appConfig");
			if (strApplicationConfigurationArgument != null) {
				if (Files.isReadable(Paths.get(strApplicationConfigurationArgument))) {
					strApplicationConfigurationFile = strApplicationConfigurationArgument;
				}
				else {
					objLogger.error(Paths.get(strApplicationConfigurationArgument).toAbsolutePath().toString());
					objLogger.error("The application configuration file, App.xml, is not found or readable");
					throw new RuntimeException("The application configuration file, App.xml, is not found or readable");
				}
			}
			else {
				objURLApplicationConfigurationFile = Thread.currentThread().getContextClassLoader().getResource(APPLICATION_CONFIGURATION);
				if (objURLApplicationConfigurationFile != null) {
					strApplicationConfigurationFile = objURLApplicationConfigurationFile.getFile();
				}
				else {
					objLogger.error("The application configuration file, App.xml, is not on the classpath");
					throw new RuntimeException("The application configuration file, App.xml, is not on the classpath");
				}
			}
						
			////////////////////////////
			// The argument seasonName  
			////////////////////////////
			strSeasonNameArgument = objArgumentParser.getOption("seasonName");
			if (strSeasonNameArgument != null) {
				strSeasonName = strSeasonNameArgument;
			}
			else {
				objLogger.error("Unable to continue without any season name");
				throw new RuntimeException("Unable to continue without any season name");
			}
			
			//////////////////////////////////////////
			// The argument previousReportsDirectory  
			//////////////////////////////////////////
			strPreviousReportsDirectoryArgument = objArgumentParser.getOption("previousReportsDirectory");
			if (strPreviousReportsDirectoryArgument != null) {
				objPreviousReportsDirectoryPath = Paths.get(strPreviousReportsDirectoryArgument);
				if (!(Files.exists(objPreviousReportsDirectoryPath))) {
					objLogger.error("The previous reports directory: " + strPreviousReportsDirectoryArgument + " does not exit");
					throw new RuntimeException("The previous reports directory: " + strPreviousReportsDirectoryArgument + " does not exit");
				}
			}
			else {
				objPreviousReportsDirectoryPath = null;
			}
			
			///////////////////////
			// The execution call  
			///////////////////////
			if (strApplicationConfigurationFile != null) {
				XML.INSTANCE.deserialize(strApplicationConfigurationFile, 
										 App.INSTANCE);
				objURLLogFile = Thread.currentThread().getContextClassLoader().getResource("log4j.properties");
				System.setProperty("log.file",
								   "main");
				System.setProperty("log.dir",
					           	   App.INSTANCE.getLogDir());
				PropertyConfigurator.configure(objURLLogFile);
				objLogger = Logger.getLogger(Main.class.getName());
				System.out.println("Generating a ValidationProcess object...");	
				objValidationProcess = new ValidationProcess(strSeasonName,
						                                     objPreviousReportsDirectoryPath);
				lngStartTime = System.currentTimeMillis();
				objValidationProcess.start();
				System.out.println("Execution Time: " + (System.currentTimeMillis() - lngStartTime) / 1000 + " seconds");
			}
			else {
				objLogger.error("Unable to continue without any application configuration file");
				throw new RuntimeException("Unable to continue without any application configuration file");
			}
		}
		catch (Exception e) {
			e.printStackTrace();
			objLogger.fatal("Main.main", 
					        e);
		}
	}
}